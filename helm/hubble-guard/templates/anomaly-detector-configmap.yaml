apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "hubble-guard.fullname" . }}-anomaly-detector-config
  namespace: hubble-guard
  labels:
    {{- include "hubble-guard.anomalyDetector.labels" . | nindent 4 }}
data:
  anomaly_detection.yaml: |
    # Anomaly Detection Configuration
    # Generated from Helm chart values
    
    application:
      hubble_server: {{ .Values.application.hubble_server | quote }}
      prometheus_export_url: {{ .Values.application.prometheus_export_url | quote }}
      default_namespace: {{ .Values.application.default_namespace | quote }}
      auto_start: {{ .Values.application.auto_start }}
    
    prometheus:
      url: {{ if .Values.prometheusConfig.url }}{{ .Values.prometheusConfig.url | quote }}{{ else }}{{ printf "http://%s:%d" (include "hubble-guard.prometheus.serviceName" .) .Values.prometheus.service.port | quote }}{{ end }}
      timeout_seconds: {{ .Values.prometheusConfig.timeout_seconds }}
      retry_attempts: {{ .Values.prometheusConfig.retry_attempts }}
      retry_delay_seconds: {{ .Values.prometheusConfig.retry_delay_seconds }}
    
    namespaces:
    {{- range .Values.namespaces }}
      - {{ . | quote }}
    {{- end }}
    
    detection:
      baseline_multiplier: {{ .Values.detection.baseline_multiplier }}
      baseline_window_minutes: {{ .Values.detection.baseline_window_minutes }}
      check_interval_seconds: {{ .Values.detection.check_interval_seconds }}
    
    rules:
    {{- range .Values.rules }}
      - name: {{ .name | quote }}
        enabled: {{ .enabled }}
        severity: {{ .severity | quote }}
        description: {{ .description | quote }}
        {{- if .type }}
        type: {{ .type | quote }}
        {{- end }}
        {{- if .thresholds }}
        thresholds:
        {{- range $key, $value := .thresholds }}
          {{- if kindIs "slice" $value }}
          {{ $key }}:
            {{- range $value }}
            - {{ . | quote }}
            {{- end }}
          {{- else }}
          {{ $key }}: {{ $value }}
          {{- end }}
        {{- end }}
        {{- end }}
    {{- end }}
    
    alerting:
      enabled: {{ .Values.alerting.enabled }}
      max_alerts_per_minute: {{ .Values.alerting.max_alerts_per_minute }}
      alert_cooldown_seconds: {{ .Values.alerting.alert_cooldown_seconds }}
      channels:
        log: {{ .Values.alerting.channels.log }}
        webhook: {{ .Values.alerting.channels.webhook }}
        email: {{ .Values.alerting.channels.email }}
        telegram: {{ .Values.alerting.channels.telegram }}
      
      telegram:
        bot_token: {{ .Values.alerting.telegram.bot_token | quote }}
        chat_id: {{ .Values.alerting.telegram.chat_id | quote }}
        parse_mode: {{ .Values.alerting.telegram.parse_mode | quote }}
        enabled: {{ .Values.alerting.telegram.enabled }}
        {{- if .Values.alerting.telegram.message_template }}
        message_template: |
{{ .Values.alerting.telegram.message_template | indent 10 }}
        {{- end }}
    
    logging:
      level: {{ .Values.logging.level | quote }}
      format: {{ .Values.logging.format | quote }}
      file_path: {{ .Values.logging.file_path | quote }}

